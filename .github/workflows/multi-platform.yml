name: Build Eclipse

on:
  workflow_dispatch:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        config:
        - name: Windows
          os: windows-latest
          build-type: RelWithDebInfo

        - name: macOS
          os: macos-latest

        - name: Android32
          os: ubuntu-latest
          target: Android32

        - name: Android64
          os: ubuntu-latest
          target: Android64

    name: ${{ matrix.config.name }}
    runs-on: ${{ matrix.config.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Build the mod
        uses: geode-sdk/build-geode-mod@main
        with:
          bindings: EclipseMenu/bindings
          bindings-ref: main
          # sdk: nightly 
          combine: true
          export-pdb: true
          target: ${{ matrix.config.target }}
          build-config: ${{ matrix.config.build-type || 'Release' }}

  package:
    name: Package builds
    runs-on: ubuntu-latest
    needs: ['build']

    steps:
      - uses: geode-sdk/build-geode-mod/combine@main
        id: build

      - uses: actions/upload-artifact@v4
        with:
          name: Geode Build
          path: ${{ steps.build.outputs.build-output }}

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ github.workspace }}/bin
          merge-multiple: true

      - name: Get latest release tag
        id: get_latest_release
        run: echo ::set-output name=tag::$(curl -s https://api.github.com/repos/Prevter/OpenHack/releases/latest | jq -r .tag_name)

      - name: Create dev release
        uses: andelf/nightly-release@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: canary
          name: 'Canary Build'
          body: |
            This is a canary build of the mod for commit ${{ github.sha }} (${{ github.event.head_commit.message }}).
            
            ## IMPORTANT NOTICE FOR PEOPLE:
            
            Whatever you do, DO NOT download ths at ANY circumstance, this contains my own changes to the code and may not be stable and may contain lots of bugs and issues.
            This can update many times during the day, because this is the first time I'm actually modding in GD, so there's a lot of trial and error, so it's just not recommended that you download this.

            ## Supported Platforms Of This Build:

            1. Windows
            2. Android
            3. MacOS
          files: |
            ${{ github.workspace }}/bin/eclipse.eclipse-menu.geode

          
